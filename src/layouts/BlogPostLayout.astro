---
import BaseLayout from './BaseLayout.astro';
import CategoryBadge from '@components/CategoryBadge.astro';
import Breadcrumbs from '@components/Breadcrumbs.astro';
import RelatedPosts from '@components/RelatedPosts.astro';
import ShareButtons from '@components/ShareButtons.astro';
import NewsletterSignup from '@components/NewsletterSignup.astro';
import TableOfContents from '@components/TableOfContents.astro';
import FaqSection from '@components/FaqSection.astro';
import { Image } from 'astro:assets';
import { getDateLocale, getLocalizedPath } from '../i18n/utils';
import { useTranslations } from '../i18n/utils';

interface FaqItem {
  question: string;
  answer: string;
}

interface Props {
  title: string;
  description: string;
  author: string;
  date: Date;
  updatedDate?: Date;
  category: string;
  tags: string[];
  coverImage: ImageMetadata;
  coverImageAlt: string;
  lang?: 'es' | 'en';
  slug: string;
  readingTime?: number;
  headings?: Array<{ depth: number; slug: string; text: string }>;
  faq?: FaqItem[];
  translationSlug?: string;
}

const {
  title,
  description,
  author,
  date,
  updatedDate,
  category,
  tags,
  coverImage,
  coverImageAlt,
  lang = 'es',
  slug,
  readingTime,
  headings = [],
  faq = [],
  translationSlug,
} = Astro.props;

const t = useTranslations(lang);
const dateLocale = getDateLocale(lang);

const formattedDate = new Intl.DateTimeFormat(dateLocale, {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).format(date);

const formattedUpdated = updatedDate
  ? new Intl.DateTimeFormat(dateLocale, {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    }).format(updatedDate)
  : null;

const categoryLabel = t(`category.${category}` as any) || category;
const articleUrl = new URL(Astro.url.pathname, Astro.site).href;

// Build articleData for JSON-LD
const articleData = {
  author,
  datePublished: date.toISOString(),
  dateModified: updatedDate?.toISOString() || date.toISOString(),
  category,
  tags,
};
---

<BaseLayout
  title={`${title} â€” Aroma de Cuba`}
  description={description}
  ogImage={typeof coverImage === 'string' ? coverImage : coverImage.src}
  article
  lang={lang}
  articleData={articleData}
  faqItems={faq}
  translationSlug={translationSlug}
  currentSlug={slug}
>
  <article>
    <header class="py-12 pb-8 text-center">
      <div class="max-w-3xl mx-auto px-6">
        <Breadcrumbs items={[
          { label: t('blog.title'), href: getLocalizedPath('blog', lang) },
          { label: categoryLabel, href: getLocalizedPath(lang === 'es' ? `blog/categoria/${category}` : `blog/category/${category}`, lang) },
          { label: title },
        ]} />
        <CategoryBadge category={category} lang={lang} />
        <h1 class="font-display text-5xl my-4 text-tabaco max-md:text-3xl" transition:name="post-title">
          {title}
        </h1>
        <p class="font-heading text-xl text-piedra-oscura italic max-w-[50ch] mx-auto">{description}</p>
        <div class="flex justify-center gap-4 mt-6 text-sm text-piedra max-md:flex-col max-md:gap-1">
          <span class="font-semibold text-piedra-oscura">{author}</span>
          <span class="max-md:hidden">&middot;</span>
          <time datetime={date.toISOString()}>{formattedDate}</time>
          {formattedUpdated && (
            <span>
              {t('post.updated')} <time datetime={updatedDate!.toISOString()}>{formattedUpdated}</time>
            </span>
          )}
          {readingTime && (
            <>
              <span class="max-md:hidden">&middot;</span>
              <span>{readingTime} {t('post.readingTime')}</span>
            </>
          )}
        </div>
      </div>
    </header>

    <div class="max-w-4xl mx-auto mb-10 px-6">
      <Image
        src={coverImage}
        alt={coverImageAlt}
        width={1200}
        height={630}
        loading="eager"
        class="w-full h-auto rounded-lg aspect-[1200/630] object-cover"
      />
    </div>

    <div class="max-w-3xl mx-auto px-6">
      <TableOfContents headings={headings} lang={lang} />

      <div class="prose">
        <slot />
      </div>

      <FaqSection items={faq} lang={lang} />

      {tags.length > 0 && (
        <footer class="flex flex-wrap gap-2 mt-10 pt-6 border-t border-ceniza">
          <span class="text-sm font-semibold text-piedra-oscura">{t('post.tags')}</span>
          {tags.map((tag) => (
            <a
              href={getLocalizedPath(lang === 'es' ? `blog/etiqueta/${tag}` : `blog/tag/${tag}`, lang)}
              class="text-sm text-ron no-underline hover:text-coral"
            >
              #{tag}
            </a>
          ))}
        </footer>
      )}

      <ShareButtons title={title} url={articleUrl} lang={lang} />

      <NewsletterSignup variant="inline" lang={lang} />

      <RelatedPosts
        currentSlug={slug}
        category={category}
        tags={tags}
        lang={lang}
      />
    </div>
  </article>
</BaseLayout>
