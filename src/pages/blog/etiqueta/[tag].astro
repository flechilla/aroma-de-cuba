---
import BaseLayout from '@layouts/BaseLayout.astro';
import SectionHero from '@components/SectionHero.astro';
import BlogCard from '@components/BlogCard.astro';
import Breadcrumbs from '@components/Breadcrumbs.astro';
import { getCollection } from 'astro:content';
import { useTranslations } from '../../../i18n/utils';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data, id }) => !data.draft && id.startsWith('es/'));
  const tags = [...new Set(posts.flatMap((p) => p.data.tags))];

  return tags.map((tag) => ({
    params: { tag },
    props: {
      posts: posts
        .filter((p) => p.data.tags.includes(tag))
        .sort((a, b) => b.data.date.getTime() - a.data.date.getTime()),
    },
  }));
}

const { tag } = Astro.params;
const { posts } = Astro.props;
const lang = 'es' as const;
const t = useTranslations(lang);

function getReadingTime(body: string | undefined): number {
  if (!body) return 1;
  const wordCount = body.split(/\s+/).filter(Boolean).length;
  return Math.max(1, Math.ceil(wordCount / 200));
}
---

<BaseLayout
  title={`#${tag} — Aroma de Cuba`}
  description={`Artículos etiquetados con "${tag}" en Aroma de Cuba`}
  lang={lang}
>
  <SectionHero title={`#${tag}`} description={`${posts.length} artículos`} />

  <div class="w-full max-w-[72rem] mx-auto px-6 py-12 pb-20">
    <Breadcrumbs items={[
      { label: t('blog.title'), href: '/blog' },
      { label: `#${tag}` },
    ]} />

    <div class="grid grid-cols-[repeat(auto-fill,minmax(min(100%,20rem),1fr))] gap-6">
      {posts.map((post) => (
        <BlogCard
          title={post.data.title}
          description={post.data.description}
          date={post.data.date}
          category={post.data.category}
          coverImage={post.data.coverImage}
          coverImageAlt={post.data.coverImageAlt}
          slug={post.id}
          lang={lang}
          readingTime={getReadingTime(post.body)}
        />
      ))}
    </div>
  </div>
</BaseLayout>
