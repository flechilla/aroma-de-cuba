---
import BaseLayout from '@layouts/BaseLayout.astro';
import BlogCard from '@components/BlogCard.astro';
import NewsletterSignup from '@components/NewsletterSignup.astro';
import DatoDelDia from '@components/DatoDelDia.astro';
import { getCollection } from 'astro:content';
import { useTranslations } from '../i18n/utils';

const lang = 'es' as const;
const t = useTranslations(lang);

const allPosts = await getCollection('blog', ({ data, id }) => !data.draft && id.startsWith('es/'));
const sortedPosts = allPosts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);

function getReadingTime(body: string | undefined): number {
  if (!body) return 1;
  const wordCount = body.split(/\s+/).filter(Boolean).length;
  return Math.max(1, Math.ceil(wordCount / 200));
}

const featuredPost = sortedPosts.find((p) => p.data.featured) || sortedPosts[0];
const recentPosts = sortedPosts
  .filter((p) => p.id !== featuredPost?.id)
  .slice(0, 6);

const sections = [
  { title: t('home.sectionHistory'), description: t('home.sectionHistoryDesc'), href: '/historia', color: 'var(--color-ron)' },
  { title: t('home.sectionCulture'), description: t('home.sectionCultureDesc'), href: '/cultura', color: 'var(--color-palma)' },
  { title: t('home.sectionTourism'), description: t('home.sectionTourismDesc'), href: '/turismo', color: 'var(--color-azul)' },
  { title: t('home.sectionGastronomy'), description: t('home.sectionGastronomyDesc'), href: '/gastronomia', color: 'var(--color-sol)' },
  { title: t('home.sectionProducts'), description: t('home.sectionProductsDesc'), href: '/productos', color: 'var(--color-tabaco)' },
  { title: t('home.sectionNews'), description: t('home.sectionNewsDesc'), href: '/blog', color: 'var(--color-coral)' },
];
---

<BaseLayout
  title={t('home.metaTitle')}
  description={t('home.metaDescription')}
  lang={lang}
>
  <!-- Immersive Hero -->
  <section class="bg-gradient-to-br from-tabaco via-humo to-tabaco text-arena py-24 pb-20 text-center relative overflow-hidden">
    <div class="absolute inset-0 opacity-5 bg-[radial-gradient(circle_at_30%_50%,var(--color-coral),transparent_50%),radial-gradient(circle_at_70%_30%,var(--color-azul),transparent_50%)]"></div>
    <div class="relative z-10 w-full max-w-[72rem] mx-auto px-6">
      <p class="font-body text-sm uppercase tracking-widest text-ceniza mb-4">{t('home.heroTagline')}</p>
      <h1 class="font-display text-6xl text-arena mb-4 tracking-tight max-sm:text-4xl">{t('home.title')}</h1>
      <p class="font-heading text-xl text-ceniza italic mb-8">{t('home.subtitle')}</p>
      <div class="tile-border max-w-24 mx-auto" aria-hidden="true"></div>
      <a href="/blog" class="inline-block mt-8 px-8 py-3 bg-coral text-blanco font-body text-sm font-semibold rounded no-underline transition-colors hover:bg-rojo">
        {t('home.heroCta')} &rarr;
      </a>
    </div>
  </section>

  <!-- Featured Post -->
  {featuredPost && (
    <section class="py-12 w-full max-w-[72rem] mx-auto px-6" aria-labelledby="featured-heading">
      <h2 id="featured-heading" class="sr-only">{t('home.featuredHeading')}</h2>
      <BlogCard
        title={featuredPost.data.title}
        description={featuredPost.data.description}
        date={featuredPost.data.date}
        category={featuredPost.data.category}
        coverImage={featuredPost.data.coverImage}
        coverImageAlt={featuredPost.data.coverImageAlt}
        slug={featuredPost.id}
        featured
        lang={lang}
        readingTime={getReadingTime(featuredPost.body)}
      />
    </section>
  )}

  <!-- Dato del Dia -->
  <section class="w-full max-w-[72rem] mx-auto px-6 pb-12">
    <DatoDelDia lang={lang} />
  </section>

  <!-- Recent Posts -->
  {recentPosts.length > 0 && (
    <section class="py-12 w-full max-w-[72rem] mx-auto px-6" aria-labelledby="recent-heading">
      <h2 id="recent-heading" class="font-display text-3xl text-tabaco mb-8">{t('home.latestNews')}</h2>
      <div class="grid grid-cols-[repeat(auto-fill,minmax(min(100%,20rem),1fr))] gap-6">
        {recentPosts.map((post) => (
          <BlogCard
            title={post.data.title}
            description={post.data.description}
            date={post.data.date}
            category={post.data.category}
            coverImage={post.data.coverImage}
            coverImageAlt={post.data.coverImageAlt}
            slug={post.id}
            lang={lang}
            readingTime={getReadingTime(post.body)}
          />
        ))}
      </div>
      <div class="text-center mt-10">
        <a href="/blog" class="inline-block font-body text-sm font-semibold text-blanco bg-coral px-8 py-3 rounded no-underline transition-colors hover:bg-rojo">
          {t('home.viewAllNews')}
        </a>
      </div>
    </section>
  )}

  <!-- Category Showcase -->
  <section class="py-12 w-full max-w-[72rem] mx-auto px-6" aria-labelledby="explore-heading">
    <h2 id="explore-heading" class="font-display text-3xl text-tabaco mb-8">{t('home.exploreCuba')}</h2>
    <div class="grid grid-cols-[repeat(auto-fill,minmax(14rem,1fr))] gap-6">
      {sections.map(({ title, description, href, color }) => (
        <a href={href} class="block p-8 px-6 bg-blanco border border-ceniza border-t-3 rounded-lg no-underline transition-all hover:shadow-[var(--shadow-warm-md)] hover:-translate-y-0.5" style={`border-top-color: ${color}`}>
          <h3 class="font-heading text-xl text-tabaco mb-2">{title}</h3>
          <p class="text-sm text-piedra-oscura leading-relaxed">{description}</p>
        </a>
      ))}
    </div>
  </section>

  <!-- Newsletter CTA -->
  <NewsletterSignup variant="section" lang={lang} />
</BaseLayout>
