---
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../i18n/utils';
import LanguageSwitcher from './LanguageSwitcher.astro';
import SearchDialog from './SearchDialog.astro';

interface Props {
  alternateHref?: string;
}

const { alternateHref } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const currentPath = Astro.url.pathname;

const homeHref = getLocalizedPath('', lang);

// Mega-menu structure
const discoverItems = [
  { href: getLocalizedPath(lang === 'es' ? 'historia' : 'history', lang), label: t('nav.history') },
  { href: getLocalizedPath(lang === 'es' ? 'cultura' : 'culture', lang), label: t('nav.culture') },
  { href: getLocalizedPath(lang === 'es' ? 'turismo' : 'tourism', lang), label: t('nav.tourism') },
];

const flavorItems = [
  { href: getLocalizedPath(lang === 'es' ? 'gastronomia' : 'gastronomy', lang), label: t('nav.gastronomy') },
  { href: getLocalizedPath(lang === 'es' ? 'productos' : 'products', lang), label: t('nav.products') },
];

const navGroups = [
  { href: getLocalizedPath('blog', lang), label: t('nav.news'), children: null },
  { href: null, label: t('nav.discover'), children: discoverItems },
  { href: null, label: t('nav.flavor'), children: flavorItems },
  { href: getLocalizedPath('about', lang), label: t('nav.about'), children: null },
];
---

<header class="sticky top-0 z-50 bg-blanco border-b border-ceniza h-[4.5rem]">
  <nav class="flex items-center justify-between h-full w-full max-w-[72rem] mx-auto px-6" aria-label={t('header.mainNav')}>
    <a href={homeHref} class="no-underline flex items-center gap-2" aria-label={t('header.logoLabel')}>
      <img src="/images/brand/zunzun-square-centered.png" alt="" class="w-10 h-10" width="40" height="40" />
      <span class="font-display text-2xl font-bold text-tabaco tracking-tight">Aroma de Cuba</span>
    </a>

    <button
      class="hidden max-md:block bg-transparent border-none cursor-pointer p-2"
      aria-expanded="false"
      aria-controls="main-nav"
      aria-label={t('header.openMenu')}
      id="menu-toggle"
    >
      <span class="block w-6 h-0.5 bg-tabaco relative before:content-[''] before:absolute before:left-0 before:w-full before:h-0.5 before:bg-tabaco before:-top-[7px] before:transition-transform before:duration-250 after:content-[''] after:absolute after:left-0 after:w-full after:h-0.5 after:bg-tabaco after:top-[7px] after:transition-transform after:duration-250" aria-hidden="true"></span>
    </button>

    <div id="main-nav" class="flex items-center gap-1 max-md:hidden max-md:absolute max-md:top-[4.5rem] max-md:left-0 max-md:right-0 max-md:flex-col max-md:bg-blanco max-md:border-b max-md:border-ceniza max-md:p-4 max-md:px-6 max-md:shadow-[var(--shadow-warm-lg)] max-md:items-stretch">
      {navGroups.map((group) => (
        group.children ? (
          <div class="relative group/dropdown">
            <button class="font-body text-sm font-medium text-piedra-oscura py-2 px-3 rounded transition-colors hover:text-tabaco hover:bg-arena bg-transparent border-none cursor-pointer flex items-center gap-1 max-md:w-full max-md:py-3 max-md:px-4 max-md:text-base max-md:justify-between" data-dropdown-trigger>
              {group.label}
              <svg class="w-3 h-3 transition-transform group-hover/dropdown:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div class="absolute left-0 top-full pt-1 hidden group-hover/dropdown:block max-md:relative max-md:pt-0 max-md:block max-md:hidden" data-dropdown-menu>
              <div class="bg-blanco border border-ceniza rounded-lg shadow-[var(--shadow-warm-md)] py-2 min-w-40 max-md:border-0 max-md:shadow-none max-md:py-0 max-md:pl-4">
                {group.children.map((item) => (
                  <a
                    href={item.href}
                    class:list={[
                      'block px-4 py-2 text-sm text-piedra-oscura no-underline transition-colors hover:text-tabaco hover:bg-arena max-md:py-2 max-md:px-3',
                      { '!text-coral !font-semibold': currentPath.startsWith(item.href) },
                    ]}
                  >
                    {item.label}
                  </a>
                ))}
              </div>
            </div>
          </div>
        ) : (
          <a
            href={group.href!}
            class:list={[
              'font-body text-sm font-medium text-piedra-oscura no-underline py-2 px-3 rounded transition-colors hover:text-tabaco hover:bg-arena max-md:py-3 max-md:px-4 max-md:text-base max-md:block',
              { '!text-coral !font-semibold': currentPath.startsWith(group.href!) },
            ]}
            aria-current={currentPath.startsWith(group.href!) ? 'page' : undefined}
          >
            {group.label}
          </a>
        )
      ))}

      <div class="flex items-center gap-2 ml-3 pl-3 border-l border-ceniza max-md:ml-0 max-md:pl-0 max-md:border-l-0 max-md:pt-2 max-md:mt-2 max-md:border-t max-md:border-ceniza max-md:flex-row-reverse max-md:justify-end">
        <!-- Search trigger -->
        <button
          class="p-2 text-piedra-oscura bg-transparent border-none cursor-pointer rounded transition-colors hover:text-tabaco hover:bg-arena"
          data-search-trigger
          aria-label={t('header.search')}
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </button>
        <LanguageSwitcher alternateHref={alternateHref} />
      </div>
    </div>
  </nav>
</header>

<SearchDialog />

<script>
  // Mobile menu toggle
  const toggle = document.getElementById('menu-toggle');
  const nav = document.getElementById('main-nav');

  toggle?.addEventListener('click', () => {
    const isOpen = !nav?.classList.contains('max-md:hidden');
    if (isOpen) {
      nav?.classList.add('max-md:hidden');
      toggle.setAttribute('aria-expanded', 'false');
    } else {
      nav?.classList.remove('max-md:hidden');
      toggle.setAttribute('aria-expanded', 'true');
    }
  });

  // Mobile dropdown toggles
  document.querySelectorAll('[data-dropdown-trigger]').forEach((btn) => {
    btn.addEventListener('click', () => {
      if (window.innerWidth >= 768) return; // Only for mobile
      const menu = btn.nextElementSibling as HTMLElement;
      if (menu) {
        menu.classList.toggle('max-md:hidden');
      }
    });
  });
</script>
