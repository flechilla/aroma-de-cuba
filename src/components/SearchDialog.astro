---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<div id="search-dialog" class="fixed inset-0 z-[200] hidden" role="dialog" aria-modal="true" aria-label={t('search.title')}>
  <div class="absolute inset-0 bg-humo/60 backdrop-blur-sm" data-search-backdrop></div>
  <div class="relative mx-auto mt-[10vh] max-w-2xl bg-blanco rounded-lg shadow-[var(--shadow-warm-lg)] overflow-hidden max-sm:mx-4">
    <div class="p-4 border-b border-ceniza">
      <div class="flex items-center gap-3">
        <svg class="w-5 h-5 text-piedra shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <input
          type="search"
          id="search-input"
          class="flex-1 bg-transparent border-none outline-none text-humo font-body text-base placeholder:text-piedra"
          placeholder={t('search.placeholder')}
        />
        <kbd class="hidden sm:inline-flex items-center px-2 py-0.5 text-xs font-mono text-piedra bg-pergamino rounded border border-ceniza">
          ESC
        </kbd>
      </div>
    </div>
    <div id="search-results" class="max-h-[60vh] overflow-y-auto p-4">
      <p class="text-sm text-piedra text-center py-8">{t('search.placeholder')}</p>
    </div>
  </div>
</div>

<script is:inline>
  (function() {
    var dialog = document.getElementById('search-dialog');
    var backdrop = document.querySelector('[data-search-backdrop]');
    var input = document.getElementById('search-input');

    function openSearch() {
      if (dialog) dialog.classList.remove('hidden');
      if (input) input.focus();
    }

    function closeSearch() {
      if (dialog) dialog.classList.add('hidden');
      if (input) input.value = '';
    }

    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (dialog && dialog.classList.contains('hidden')) {
          openSearch();
        } else {
          closeSearch();
        }
      }
      if (e.key === 'Escape') closeSearch();
    });

    if (backdrop) backdrop.addEventListener('click', closeSearch);

    document.querySelectorAll('[data-search-trigger]').forEach(function(btn) {
      btn.addEventListener('click', openSearch);
    });

    var pagefind = null;

    async function loadPagefind() {
      if (pagefind) return pagefind;
      try {
        pagefind = await import('/pagefind/pagefind.js');
        await pagefind.init();
        return pagefind;
      } catch (e) {
        return null;
      }
    }

    if (input) {
      var debounceTimer;
      input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async function() {
          var query = input.value.trim();
          var results = document.getElementById('search-results');
          if (!results) return;

          if (!query) {
            results.innerHTML = '<p class="text-sm text-piedra text-center py-8">Type to search...</p>';
            return;
          }

          var pf = await loadPagefind();
          if (!pf) {
            results.innerHTML = '<p class="text-sm text-piedra text-center py-8">Search available after build</p>';
            return;
          }

          var search = await pf.search(query);

          // 6a. Search Event Tracking
          if (typeof gtag === 'function') {
            gtag('event', 'site_search', { search_term: query, results_count: search.results.length });
          }

          if (search.results.length === 0) {
            results.innerHTML = '<p class="text-sm text-piedra text-center py-8">No results found</p>';
            return;
          }

          var items = await Promise.all(search.results.slice(0, 8).map(function(r) { return r.data(); }));
          results.innerHTML = items.map(function(item) {
            return '<a href="' + item.url + '" data-search-result class="block p-3 rounded hover:bg-arena transition-colors no-underline mb-1">' +
              '<h3 class="font-heading text-sm font-semibold text-tabaco">' + (item.meta.title || item.url) + '</h3>' +
              '<p class="text-xs text-piedra mt-1">' + item.excerpt + '</p>' +
            '</a>';
          }).join('');

          // 6b. Search Result Click Tracking
          results.querySelectorAll('[data-search-result]').forEach(function(link) {
            link.addEventListener('click', function() {
              if (typeof gtag === 'function') {
                gtag('event', 'search_result_click', {
                  search_term: query,
                  result_url: link.getAttribute('href'),
                  result_title: (link.querySelector('h3') || {}).textContent || ''
                });
              }
            });
          });
        }, 200);
      });
    }
  })();
</script>
